#!/bin/bash
#
# Site Manager 交互式管理工具
# 用法: sm [命令号]
#

VERSION="1.0.0"
ROOT_DIR="/opt/site_manager"

# 颜色
RED="\033[31m"
GREEN="\033[32m"
YELLOW="\033[33m"
CYAN="\033[36m"
WHITE="\033[37m"
NC="\033[0m"

# 面板配置
PANEL_DIR="$ROOT_DIR/panel"
PANEL_BIN="$PANEL_DIR/site_manager_panel"
PANEL_CONFIG="$PANEL_DIR/config/config.json"
PANEL_DB="$PANEL_DIR/data/panel.db"

get_panel_port() {
    [ -f "$PANEL_CONFIG" ] && grep -o '"port":[[:space:]]*[0-9]*' "$PANEL_CONFIG" 2>/dev/null | grep -o '[0-9]*' || echo "8888"
}

get_panel_status() {
    pgrep -f "site_manager_panel" > /dev/null && echo -e "${GREEN}运行中${NC}" || echo -e "${RED}已停止${NC}"
}

get_panel_url() {
    local port=$(get_panel_port)
    local ip=$(curl -s --connect-timeout 2 ifconfig.me 2>/dev/null || hostname -I | awk '{print $1}')
    echo "http://$ip:$port"
}

show_menu() {
    clear
    echo ""
    echo -e "${GREEN}================= Site Manager v$VERSION =================${NC}"
    echo -e " 面板: $(get_panel_status)    端口: ${WHITE}$(get_panel_port)${NC}"
    echo -e "${GREEN}=========================================================${NC}"
    echo -e "${YELLOW}[面板管理]${NC}                      ${YELLOW}[站点管理]${NC}"
    echo -e " 1) 启动面板                   10) 查看站点"
    echo -e " 2) 停止面板                   11) 创建站点"
    echo -e " 3) 重启面板                   12) 删除站点"
    echo -e " 4) 面板状态                   13) 申请SSL"
    echo -e " 5) 修改端口"
    echo -e " 6) 重置密码                  ${YELLOW}[服务管理]${NC}"
    echo -e " 7) 面板日志                   20) Nginx"
    echo -e "                               21) PHP"
    echo -e "${YELLOW}[安全管理]${NC}                       22) MySQL"
    echo -e " 30) 防火墙                    23) Redis"
    echo -e " 31) SSH端口"
    echo -e "                              ${YELLOW}[系统工具]${NC}"
    echo -e "${YELLOW}[备份恢复]${NC}                       40) 系统信息"
    echo -e " 50) 备份站点                  41) 磁盘使用"
    echo -e " 51) 恢复站点                  42) 内存使用"
    echo -e " 52) 备份数据库                43) 网络连接"
    echo -e " 53) 恢复数据库"
    echo -e "${GREEN}=========================================================${NC}"
    echo -e " 0) 退出"
    echo ""
}

start_panel() {
    pgrep -f "site_manager_panel" > /dev/null && echo -e "${YELLOW}面板已在运行${NC}" && return
    echo -e "${CYAN}启动面板...${NC}"
    cd "$PANEL_DIR" && nohup "$PANEL_BIN" -port "$(get_panel_port)" > /tmp/panel.log 2>&1 &
    sleep 2
    pgrep -f "site_manager_panel" > /dev/null && echo -e "${GREEN}启动成功: $(get_panel_url)${NC}" || echo -e "${RED}启动失败${NC}"
}

stop_panel() {
    pgrep -f "site_manager_panel" > /dev/null || { echo -e "${YELLOW}面板未运行${NC}"; return; }
    pkill -f "site_manager_panel" && sleep 1 && echo -e "${GREEN}已停止${NC}"
}

restart_panel() { stop_panel; sleep 1; start_panel; }

panel_status() {
    if pgrep -f "site_manager_panel" > /dev/null; then
        local pid=$(pgrep -f "site_manager_panel" | head -1)
        echo -e " 状态: ${GREEN}运行中${NC}  PID: $pid"
        echo -e " 端口: $(get_panel_port)  地址: $(get_panel_url)"
    else
        echo -e " 状态: ${RED}已停止${NC}"
    fi
}

change_port() {
    echo -e "当前端口: $(get_panel_port)"
    read -p "新端口 (1024-65535): " p
    [[ "$p" =~ ^[0-9]+$ ]] && [ "$p" -ge 1024 ] && [ "$p" -le 65535 ] || { echo -e "${RED}无效${NC}"; return; }
    ss -tlnp | grep -q ":$p " && { echo -e "${RED}端口被占用${NC}"; return; }
    [ -f "$PANEL_CONFIG" ] && sed -i "s/\"port\":[[:space:]]*[0-9]*/\"port\": $p/" "$PANEL_CONFIG"
    ufw allow "$p/tcp" comment "Panel" 2>/dev/null
    echo -e "${GREEN}已改为 $p，请重启面板${NC}"
}

reset_password() {
    local pass=$(tr -dc 'A-Za-z0-9' < /dev/urandom | head -c 16)
    [ -f "$PANEL_DB" ] || { echo -e "${RED}数据库不存在${NC}"; return; }
    if command -v python3 &>/dev/null; then
        local hash=$(python3 -c "import bcrypt; print(bcrypt.hashpw('$pass'.encode(), bcrypt.gensalt()).decode())" 2>/dev/null)
        [ -n "$hash" ] && sqlite3 "$PANEL_DB" "UPDATE users SET password='$hash' WHERE username='admin';" 2>/dev/null
        echo -e "${GREEN}新密码: $pass${NC}"
    else
        echo -e "${YELLOW}需要 python3-bcrypt${NC}"
    fi
}

view_logs() { [ -f /tmp/panel.log ] && tail -50 /tmp/panel.log || echo "无日志"; }

list_sites() { site list; }
create_site() {
    read -p "域名: " d; [ -z "$d" ] && return
    echo "1)PHP 2)静态 3)Node 4)Proxy"
    read -p "类型[1]: " t
    case "$t" in 2)t="static";; 3)t="node";; 4)t="proxy";; *)t="php";; esac
    site create "$d" "$t"
}
delete_site() { site list; read -p "域名: " d; [ -n "$d" ] && site delete "$d"; }
ssl_request() { site list; read -p "域名: " d; [ -n "$d" ] && site ssl "$d"; }

nginx_menu() {
    echo "1)重载 2)重启 3)测试 4)状态"
    read -p "[1]: " c
    case "$c" in 2)systemctl restart nginx;; 3)nginx -t;; 4)systemctl status nginx --no-pager;; *)systemctl reload nginx;; esac
}
php_menu() {
    echo "1)版本 2)重启"
    read -p "[1]: " c
    case "$c" in 2)for v in 8.0 8.1 8.2 8.3; do systemctl restart "php${v}-fpm" 2>/dev/null; done;; *)php -v;; esac
}
mysql_menu() {
    echo "1)状态 2)重启 3)数据库"
    read -p "[1]: " c
    case "$c" in 2)systemctl restart mysql;; 3)mysql -e "SHOW DATABASES;";; *)systemctl status mysql --no-pager;; esac
}
redis_menu() {
    echo "1)状态 2)重启"
    read -p "[1]: " c
    case "$c" in 2)systemctl restart redis;; *)systemctl status redis --no-pager;; esac
}

firewall_menu() {
    ufw status numbered 2>/dev/null | head -12
    echo "1)开启 2)关闭 3)放行 4)删除"
    read -p "选择: " c
    case "$c" in
        1)ufw --force enable;; 2)ufw disable;;
        3)read -p "端口: " p; ufw allow "$p/tcp";;
        4)read -p "编号: " n; echo y|ufw delete "$n";;
    esac
}
change_ssh() {
    local cur=$(ss -tlnp|grep sshd|awk '{print $4}'|grep -oE '[0-9]+$'|head -1)
    echo "当前: ${cur:-22}"
    read -p "新端口: " p; [[ "$p" =~ ^[0-9]+$ ]] || return
    sed -i "s/^#*Port .*/Port $p/" /etc/ssh/sshd_config
    ufw allow "$p/tcp"
    read -p "重启SSH?(y/n): " c; [ "$c" = "y" ] && systemctl restart sshd
}

system_info() {
    echo " 系统: $(grep PRETTY_NAME /etc/os-release|cut -d'"' -f2)"
    echo " CPU: $(nproc)核  内存: $(free -h|awk '/Mem:/{print $2}')"
    echo " 负载: $(cat /proc/loadavg|awk '{print $1,$2,$3}')"
}
disk_usage() { df -h|grep -E "^/dev|File"; }
memory_usage() { free -h; }
network_info() { ss -tlnp|head -12; }

backup_site() { site list; read -p "域名: " d; [ -n "$d" ] && site backup "$d"; }
restore_site() { read -p "域名: " d; read -p "文件: " f; site restore "$d" "$f"; }
backup_db() { read -p "数据库: " n; [ -z "$n" ] && site db backup-all || site db export "$n"; }
restore_db() { read -p "数据库: " n; read -p "文件: " f; site db import "$n" "$f"; }

handle_command() {
    case "$1" in
        1)start_panel;; 2)stop_panel;; 3)restart_panel;; 4)panel_status;;
        5)change_port;; 6)reset_password;; 7)view_logs;;
        10)list_sites;; 11)create_site;; 12)delete_site;; 13)ssl_request;;
        20)nginx_menu;; 21)php_menu;; 22)mysql_menu;; 23)redis_menu;;
        30)firewall_menu;; 31)change_ssh;;
        40)system_info;; 41)disk_usage;; 42)memory_usage;; 43)network_info;;
        50)backup_site;; 51)restore_site;; 52)backup_db;; 53)restore_db;;
        0|q)exit 0;; *)echo -e "${RED}无效${NC}";;
    esac
}

main() {
    [ "$EUID" -ne 0 ] && echo "请用 root 运行" && exit 1
    [ -n "$1" ] && { handle_command "$1"; exit 0; }
    while true; do
        show_menu
        read -p "选项: " c
        handle_command "$c"
        read -p "回车继续..."
    done
}

main "$@"
